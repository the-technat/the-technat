<!doctype html><html lang=en-us><head><title>backups</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><style>@import "https://fonts.googleapis.com/css2?family=Inconsolata&display=swap";:root{--cursor-visibility:hidden}html,body{width:100%;height:100%;overflow:auto;font-family:inconsolata,monospace;font-size:4vmin;line-height:4.1vmin;font-weight:400}body{margin:0;display:flex;flex-direction:row;justify-content:center;align-items:center}#content{min-width:82vmin;min-height:82vmin}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{border-radius:10px;box-shadow:inset 0 0 1px white}::-webkit-scrollbar-thumb{border-radius:10px;box-shadow:0 0 0 1px white}.cursor,#activity-title:after,#activity-content:after,#cd:after,#whoami:after,#cat:after,#tree:after{visibility:var(--cursor-visibility);content:"|";overflow:hidden;color:#fff;animation:blink 500ms linear infinite alternate}@keyframes blink{0%{opacity:0}100%{opacity:1}}@media only screen and (min-width:768px){body{font-size:2.5vmin;line-height:2.6vmin}#content{min-width:60vmin}}:root{--cursor-visibility:hidden}body{align-items:unset;overflow-y:scroll}#content{max-width:80vmin}pre{overflow-x:scroll;white-space:pre}@keyframes blink{0%{opacity:0}100%{opacity:1}}body{background:#002b36}body #terminal{color:#839496}body #user{color:#859900}body #dir{color:#268bd2}body .Typewriter__cursor{color:#839496}a{color:#839496}.navFull{background-color:#353535;font-family:courier new;font-size:17px;display:inline;position:fixed;bottom:0;left:0;width:100%;padding-top:5px;padding:10px;padding-bottom:0}.navCredits{float:right;padding-right:18px;padding-bottom:10px;padding-top:5px}#content::after{content:"\a\a";white-space:pre}</style></head><body><div id=content><span id=activity-title></span><br><span id=activity-content></span><br><script type=text/javascript>async function typewriter(e,t,n){var s=0,o=!1;addText="";const i=document.getElementById(t),a=()=>new Promise(e=>setTimeout(e,n)),r=()=>new Promise(e=>e()),c=()=>i.innerHTML=e.slice(0,s+1)+addText,l=document.createElement("span");for(l.id="blink",i.style.setProperty("--cursor-visibility","visible");s<e.length;){if(e.charAt(s+1)==="<"&&(o=!0),e.charAt(s+1)===">"&&(o=!1),o){s++;continue}requestAnimationFrame(c),n===0?await r():await a(),s++}i.style.setProperty("--cursor-visibility","collapse")}function parseDelay(e){const t=parseInt(e,10);return isNaN(t)?0:t}const titleDelay=parseDelay("0"),contentDelay=parseDelay("0"),typeeffetct=async()=>{await typewriter("\u003cspan id=\u0027terminal\u0027\u003e\u003ch1 id=\u0027title\u0027\u003ebackups\u003c/h1\u003e\u003c/span\u003e","activity-title",titleDelay),await typewriter(`\u003cspan id=\u0027terminal\u0027\u003e\u003cp\u003eThis page describes how to backup files using restic.\u003c/p\u003e
\u003ch2 id=\u0022concept\u0022\u003eConcept\u003c/h2\u003e
\u003cp\u003eWe need backups, that\u0026rsquo;s abvious. But how? My concept is to only backup data on a file based layer, no server backups or configuration backup as this should all be in a wiki or in a git repository.\u003c/p\u003e
\u003cp\u003eAs backup target I use Infomaniak Swiss Backup. Primarly using \u003ca href=\u0022https://restic.readthedocs.io/en/latest/\u0022\u003erestic\u003c/a\u003e and an s3 repository.\u003c/p\u003e
\u003ch2 id=\u0022restic\u0022\u003eRestic\u003c/h2\u003e
\u003ch3 id=\u0022init-repository\u0022\u003eInit Repository\u003c/h3\u003e
\u003cp\u003eThe restic s3 repository needs to be initialized. For this we need an env file contaning the following informations:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eexport AWS_ACCESS_KEY_ID\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;your-access-key\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eexport AWS_SECRET_ACCESS_KEY\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;your-secret-key\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eexport RESTIC_REPOSITORY\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;s3:server-url/bucket-name\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eexport RESTIC_PASSWORD\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;a-strong-password\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAdd them to a file \u003ccode\u003e~/.restic-env\u003c/code\u003e and then source using \u003ccode\u003esource ~/.restic-env\u003c/code\u003e.\u003c/p\u003e
\u003cp\u003eIf this file is sourced you can init the repository using:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic init
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNote: You only do this once, then you will never ever thave to do that.\u003c/p\u003e
\u003ch3 id=\u0022file-backup\u0022\u003eFile backup\u003c/h3\u003e
\u003cp\u003eYou can always backup to the same s3 repository as long as you use restic. So please use this method on as many servers as you can so that deduplication start to shine ;).\u003c/p\u003e
\u003cp\u003eFor a file/directoy to the following to back it up:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic backup ~
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\u0022automated-backups\u0022\u003eAutomated backups\u003c/h3\u003e
\u003cp\u003eYou can install the following crontab to a user that has access to the files you want to backup:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e42\u003c/span\u003e * * * * . /home/technat/restic-backup.sh
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhere the script is:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e#!/usr/bin/bash
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;Header
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eScript:   restic-backup.sh
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eDate:     24.01.2022
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eAuthor:   Technat (Nathanael Liechti)
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eVersion:  0.0
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eHistory   User    Date        Change
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e          technat 24.01.2022  Initial Version 1.0
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eDescription: a backup script backing up the necessary files on a Nextcloud server using restic
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eCronjob: @daily /var/www/restic-backup.sh
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eDependency: restic, pg_dump
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eDocs: https://restic.readthedocs.io/en/latest/
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eÂ© Technat
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eHeader\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Variables\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Source vars\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eDATA_DIR\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;/data/nc\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eWEBROOT_DIR\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;/var/www/technat.cloud\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eDB_NAME\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;ncdb\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Restic\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eENV_FILE\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;/var/www/.restic-env\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Checks\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecommand -v restic \u0026gt;/dev/null 2\u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e||\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e{\u003c/span\u003e echo \u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e2\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;restic is not installed.  Aborting.\u0026#34;\u003c/span\u003e; exit 1; \u003cspan style=\u0022color:#f92672\u0022\u003e}\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e[\u003c/span\u003e ! -f \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u003c/span\u003e\$ENV_FILE\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e]\u003c/span\u003e; \u003cspan style=\u0022color:#66d9ef\u0022\u003ethen\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e    echo \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u003c/span\u003e\$ENV_FILE\u003cspan style=\u0022color:#e6db74\u0022\u003e does not exist. Aborting\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e    exit \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eelse\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  source \$ENV_FILE
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efi\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e[[\u003c/span\u003e \$RESTIC_PASSWORD \u003cspan style=\u0022color:#f92672\u0022\u003e==\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e]]\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003ethen\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  echo \u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e2\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\\\$RESTIC_PASSWORD is not set. Aborting\u0026#34;\u003c/span\u003e; exit \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efi\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e[[\u003c/span\u003e \$RESTIC_REPOSITORY \u003cspan style=\u0022color:#f92672\u0022\u003e==\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e]]\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003ethen\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  echo \u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e2\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\\\$RESTIC_REPOSITORY is not set. Aborting\u0026#34;\u003c/span\u003e; exit \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efi\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e[[\u003c/span\u003e \$AWS_ACCESS_KEY_ID \u003cspan style=\u0022color:#f92672\u0022\u003e==\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e]]\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003ethen\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  echo \u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e2\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\\\$AWS_ACCESS_KEY_ID is not set. Aborting\u0026#34;\u003c/span\u003e; exit \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efi\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003eif\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e[[\u003c/span\u003e \$AWS_SECRET_ACCESS_KEY \u003cspan style=\u0022color:#f92672\u0022\u003e==\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan style=\u0022color:#f92672\u0022\u003e]]\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003ethen\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  echo \u0026gt;\u0026amp;\u003cspan style=\u0022color:#ae81ff\u0022\u003e2\u003c/span\u003e \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;\\\$AWS_SECRET_ACCESS_KEY is not set. Aborting\u0026#34;\u003c/span\u003e; exit \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003efi\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Main Script\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e###############\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Enable maintenance mode\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ephp \$WEBROOT_DIR/occ maintenance:mode --on
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# backup data dir\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic backup -v \$DATA_DIR
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# backup webroot\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic backup -v \$WEBROOT_DIR
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# db dump\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003epg_dump -U www-data -w \$DB_NAME -F p | restic backup -v --stdin --stdin-filename \$DB_NAME\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;_dump.sql\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# disable maintenance mode\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ephp \$WEBROOT_DIR/occ maintenance:mode --off
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# forget and prune old snapshots\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic forget -q --prune --keep-hourly \u003cspan style=\u0022color:#ae81ff\u0022\u003e24\u003c/span\u003e --keep-daily \u003cspan style=\u0022color:#ae81ff\u0022\u003e7\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis will do the following:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003eEnable maintenance mode on nextcloud (remove that if you don\u0026rsquo;t use this for a nextcloud)\u003c/li\u003e
\u003cli\u003eBackup data dir and webroot\u003c/li\u003e
\u003cli\u003eDo postgres db dump and save the file as well\u003c/li\u003e
\u003cli\u003eDelete old snapshots except 24 hour and 7 days old ones\u003c/li\u003e
\u003c/ul\u003e
\u003ch3 id=\u0022restore-backup\u0022\u003eRestore Backup\u003c/h3\u003e
\u003cp\u003eYou can list all backups using:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic snapshots
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd restore one:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erestic restore 427696a3 --target /tmp/restore
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\u0022cleanup\u0022\u003eCleanup\u003c/h3\u003e
\u003cp\u003eI recommend you start cleaning old snapshots regurarly using the following cronjob somewhere:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e@weekly source /home/technat/.restic-env \u003cspan style=\u0022color:#f92672\u0022\u003e\u0026amp;\u0026amp;\u003c/span\u003e usr/local/bin/restic forget -q --prune --keep-hourly \u003cspan style=\u0022color:#ae81ff\u0022\u003e24\u003c/span\u003e --keep-daily \u003cspan style=\u0022color:#ae81ff\u0022\u003e7\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\u0022further-reading\u0022\u003eFurther reading\u003c/h2\u003e
\u003cul\u003e
\u003cli\u003e\u003ca href=\u0022https://www.digitalocean.com/community/tutorials/how-to-back-up-data-to-an-object-storage-service-with-the-restic-backup-client\u0022\u003eDigitalocean Guide\u003c/a\u003e\u003c/li\u003e
\u003cli\u003e\u003ca href=\u0022https://restic.readthedocs.io/en/latest/\u0022\u003eDocs\u003c/a\u003e\u003c/li\u003e
\u003c/ul\u003e
\u003c/span\u003e`,"activity-content",contentDelay)};typeeffetct()</script></div><span class=navFull><span><a href=/>Home</a>
<span>&#8192;|&#8192;</span>
<a href=./..>/linux/</a></span>
<span class=navCredits>Hugo theme created by
<a href=https://github.com/Yukuro/hugo-theme-shell target=_blank rel=noopener>Yukuro</a></span></span></body></html>