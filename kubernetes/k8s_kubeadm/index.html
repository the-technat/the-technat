<!doctype html><html lang=en-us><head><title>k8s_kubeadm</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><style>@import "https://fonts.googleapis.com/css2?family=Inconsolata&display=swap";:root{--cursor-visibility:hidden}html,body{width:100%;height:100%;overflow:auto;font-family:inconsolata,monospace;font-size:4vmin;line-height:4.1vmin;font-weight:400}body{margin:0;display:flex;flex-direction:row;justify-content:center;align-items:center}#content{min-width:82vmin;min-height:82vmin}::-webkit-scrollbar{width:10px}::-webkit-scrollbar-track{border-radius:10px;box-shadow:inset 0 0 1px white}::-webkit-scrollbar-thumb{border-radius:10px;box-shadow:0 0 0 1px white}.cursor,#activity-title:after,#activity-content:after,#cd:after,#whoami:after,#cat:after,#tree:after{visibility:var(--cursor-visibility);content:"|";overflow:hidden;color:#fff;animation:blink 500ms linear infinite alternate}@keyframes blink{0%{opacity:0}100%{opacity:1}}@media only screen and (min-width:768px){body{font-size:2.5vmin;line-height:2.6vmin}#content{min-width:60vmin}}:root{--cursor-visibility:hidden}body{align-items:unset;overflow-y:scroll}#content{max-width:80vmin}pre{overflow-x:scroll;white-space:pre}@keyframes blink{0%{opacity:0}100%{opacity:1}}body{background:#002b36}body #terminal{color:#839496}body #user{color:#859900}body #dir{color:#268bd2}body .Typewriter__cursor{color:#839496}a{color:#839496}.navFull{background-color:#353535;font-family:courier new;font-size:17px;display:inline;position:fixed;bottom:0;left:0;width:100%;padding-top:5px;padding:10px;padding-bottom:0}.navCredits{float:right;padding-right:18px;padding-bottom:10px;padding-top:5px}#content::after{content:"\a\a";white-space:pre}</style></head><body><div id=content><span id=activity-title></span><br><span id=activity-content></span><br><script type=text/javascript>async function typewriter(e,t,n){var s=0,o=!1;addText="";const i=document.getElementById(t),a=()=>new Promise(e=>setTimeout(e,n)),r=()=>new Promise(e=>e()),c=()=>i.innerHTML=e.slice(0,s+1)+addText,l=document.createElement("span");for(l.id="blink",i.style.setProperty("--cursor-visibility","visible");s<e.length;){if(e.charAt(s+1)==="<"&&(o=!0),e.charAt(s+1)===">"&&(o=!1),o){s++;continue}requestAnimationFrame(c),n===0?await r():await a(),s++}i.style.setProperty("--cursor-visibility","collapse")}function parseDelay(e){const t=parseInt(e,10);return isNaN(t)?0:t}const titleDelay=parseDelay("0"),contentDelay=parseDelay("0"),typeeffetct=async()=>{await typewriter("\u003cspan id=\u0027terminal\u0027\u003e\u003ch1 id=\u0027title\u0027\u003ek8s_kubeadm\u003c/h1\u003e\u003c/span\u003e","activity-title",titleDelay),await typewriter(`\u003cspan id=\u0027terminal\u0027\u003e\u003cp\u003eThis is my current approach on how to setup Kubernetes for labing purposes. I\u0026rsquo;m not a fan of automation when It comes to trying things out, so my setup is completely manual using kubeadm.\u003c/p\u003e
\u003cp\u003eHere are some other aspects of my setup that will be part of this guide:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003eMy Cloud Provider of choice is currently \u003ca href=\u0022https://www.hetzner.com/de/\u0022\u003eHetzner\u003c/a\u003e\u003c/li\u003e
\u003cli\u003ePublic facing K8s - no traffic going over private networks\u003c/li\u003e
\u003cli\u003eMy CNI of choice is currently Cilium with pod to pod encryption using wireguard\u003c/li\u003e
\u003c/ul\u003e
\u003ch2 id=\u0022prerequisites\u0022\u003ePrerequisites\u003c/h2\u003e
\u003cp\u003eBefore we dive into the details on how to setup, here are some prerequisites to met when you want to follow allong:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003e\u003ca href=\u0022https://accounts.hetzner.com/login\u0022\u003eCreate\u003c/a\u003e an Account on Hetzner Cloud\u003c/li\u003e
\u003cli\u003eCreate a Project - call it something meaningful (like cucumber)\u003c/li\u003e
\u003cli\u003eAdd a ssh-key to the project and mark it as the default key\u003c/li\u003e
\u003c/ul\u003e
\u003ch2 id=\u0022infrastructure\u0022\u003eInfrastructure\u003c/h2\u003e
\u003cp\u003eLet\u0026rsquo;s quickly talk about the infrastructure I\u0026rsquo;m using for this guide.\u003c/p\u003e
\u003cp\u003eFirst start with everything you need outside the servers:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003e
\u003cp\u003eA DNS record pointing to all of your master nodes\u003c/p\u003e
\u003c/li\u003e
\u003cli\u003e
\u003cp\u003ePlacement Groups: one for workers, one for masters\u003c/p\u003e
\u003c/li\u003e
\u003cli\u003e
\u003cp\u003eFirewall Rules: one for masters, one for workers using the following rules:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003eNote: this list is not final by any way, kubeadm requires more ports to be open\u003c/li\u003e
\u003cli\u003emasters:\u003c/li\u003e
\u003c/ul\u003e
\u003ctable\u003e
\u003cthead\u003e
\u003ctr\u003e
\u003cth\u003eType\u003c/th\u003e
\u003cth\u003eSource\u003c/th\u003e
\u003cth\u003eProtocol\u003c/th\u003e
\u003cth\u003ePort\u003c/th\u003e
\u003c/tr\u003e
\u003c/thead\u003e
\u003ctbody\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e59245\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eICMP\u003c/td\u003e
\u003ctd\u003e-\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e6443\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e2379-2380\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e2379-2380\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e10250\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e10259\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e10257\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e4240\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e4240\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e8472\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e8472\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e51871\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e51871\u003c/td\u003e
\u003c/tr\u003e
\u003c/tbody\u003e
\u003c/table\u003e
\u003cul\u003e
\u003cli\u003eworkers:\u003c/li\u003e
\u003c/ul\u003e
\u003ctable\u003e
\u003cthead\u003e
\u003ctr\u003e
\u003cth\u003eType\u003c/th\u003e
\u003cth\u003eSource\u003c/th\u003e
\u003cth\u003eProtocol\u003c/th\u003e
\u003cth\u003ePort\u003c/th\u003e
\u003c/tr\u003e
\u003c/thead\u003e
\u003ctbody\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e59245\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eICMP\u003c/td\u003e
\u003ctd\u003e-\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e30000 - 32768\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003e0.0.0.0/0, ::/0\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e30000 - 32768\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e10250\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e4240\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eTCP\u003c/td\u003e
\u003ctd\u003e4240\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e8472\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e8472\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e51871\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eIncoming\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003eUDP\u003c/td\u003e
\u003ctd\u003e51871\u003c/td\u003e
\u003c/tr\u003e
\u003c/tbody\u003e
\u003c/table\u003e
\u003c/li\u003e
\u003c/ul\u003e
\u003cp\u003eKubernetes requires you to have an odd number of master nodes, for true HA. Also many applications you may install require three replicas that are spread accross different nodes, so at least three worker nodes are ideal too. So here\u0026rsquo;s a list of all the servers I\u0026rsquo;m going to create:\u003c/p\u003e
\u003ctable\u003e
\u003cthead\u003e
\u003ctr\u003e
\u003cth\u003eLocation\u003c/th\u003e
\u003cth\u003eImage\u003c/th\u003e
\u003cth\u003eType\u003c/th\u003e
\u003cth\u003eNetworks\u003c/th\u003e
\u003cth\u003ePlacement Group\u003c/th\u003e
\u003cth\u003eBackups\u003c/th\u003e
\u003cth\u003eName\u003c/th\u003e
\u003cth\u003eLabels\u003c/th\u003e
\u003c/tr\u003e
\u003c/thead\u003e
\u003ctbody\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCPX11\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003etrue\u003c/td\u003e
\u003ctd\u003elion\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,master=true\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCPX11\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003etrue\u003c/td\u003e
\u003ctd\u003egiraffe\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,master=true\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCPX11\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003emasters\u003c/td\u003e
\u003ctd\u003etrue\u003c/td\u003e
\u003ctd\u003egorilla\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,master=true\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCX21\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003efalse\u003c/td\u003e
\u003ctd\u003eburro-01\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,worker=true\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCX21\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003efalse\u003c/td\u003e
\u003ctd\u003eburro-02\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,worker=true\u003c/td\u003e
\u003c/tr\u003e
\u003ctr\u003e
\u003ctd\u003eHelsinki\u003c/td\u003e
\u003ctd\u003eUbuntu 22.04\u003c/td\u003e
\u003ctd\u003eCX21\u003c/td\u003e
\u003ctd\u003ek8s, ipv4\u003c/td\u003e
\u003ctd\u003eworkers\u003c/td\u003e
\u003ctd\u003efalse\u003c/td\u003e
\u003ctd\u003eburro-03\u003c/td\u003e
\u003ctd\u003ecluster=technat_ch,worker=true\u003c/td\u003e
\u003c/tr\u003e
\u003c/tbody\u003e
\u003c/table\u003e
\u003cp\u003eSome notes:\u003c/p\u003e
\u003cul\u003e
\u003cli\u003eAll my servers are initalized with a \u003ca href=\u0022https://wiki.technat.ch/Linux/cloud_init.html\u0022\u003ecloud-init\u003c/a\u003e config to speed up.\u003c/li\u003e
\u003cli\u003eExpect the size and number of workers to change over time.\u003c/li\u003e
\u003cli\u003eThat\u0026rsquo;s also the reason why I don\u0026rsquo;t add DNS records for my nodes. They should be as ephemeral as possible.\u003c/li\u003e
\u003cli\u003eHowever you should have a DNS record for your kubeapi where you have added all master node IPs as valid answers (e.g three records for the same domain name). This is the simplest way to avoid an external load balancer in front of your control plane (of course you could do that too and just forward port 6443 to all the master nodes)\u003c/li\u003e
\u003c/ul\u003e
\u003cp\u003eOh and a word about networking too: After trying different szenarious, I realized that dual-stack isn\u0026rsquo;t an option, as it\u0026rsquo;s just too complicated and error prone. IPv6 only would be my desired setup, but unfortunately that currently doesn\u0026rsquo;t work (not even Github can be rechached over IPv6). So the only solution I found reliable was IPv4 only.\u003c/p\u003e
\u003ch2 id=\u0022os-preparations\u0022\u003eOS Preparations\u003c/h2\u003e
\u003cp\u003eNow that the servers are up and running, we will need to prepare all nodes according to the \u003ca href=\u0022https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/\u0022\u003einstall kubeadm\u003c/a\u003e docs.\u003c/p\u003e
\u003ch3 id=\u0022swap\u0022\u003eSwap\u003c/h3\u003e
\u003cp\u003eThe first of them is Swap. Swap must be completly disabled on all nodes. Mine already had that, make sure yours have it disabled too.\u003c/p\u003e
\u003ch3 id=\u0022container-runtime\u0022\u003eContainer Runtime\u003c/h3\u003e
\u003cp\u003eThe \u003ca href=\u0022https://kubernetes.io/docs/setup/production-environment/container-runtimes/\u0022\u003econtainer runtime\u003c/a\u003e must be installed previous to the cluster bootstraping. There are various runtimes that fulfil the CRI. I\u0026rsquo;m using Containerd as its simple and minimal.\u003c/p\u003e
\u003cp\u003eThe steps to install can be checked in the linked documentation or here.\u003c/p\u003e
\u003cp\u003eFrist let\u0026rsquo;s load the br_netfilter module and set some forwarding settings:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecat \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eoverlay
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003ebr_netfilter
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eEOF\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo modprobe overlay
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo modprobe br_netfilter
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Setup required sysctl params, these persist across reboots.\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecat \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003enet.bridge.bridge-nf-call-iptables  = 1
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003enet.ipv4.ip_forward                 = 1
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003enet.bridge.bridge-nf-call-ip6tables = 1
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eEOF\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#75715e\u0022\u003e# Apply sysctl params without reboot\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo sysctl --system
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ethen we need to add the docker repository in order to install containerd:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get update
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get install \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e  ca-certificates \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e  curl \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e  gnupg \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e  lsb-release -y
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo mkdir -p /etc/apt/keyrings
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eecho \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e  \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;deb [arch=\u003c/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003e\$(\u003c/span\u003edpkg --print-architecture\u003cspan style=\u0022color:#66d9ef\u0022\u003e)\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e  \u003c/span\u003e\u003cspan style=\u0022color:#66d9ef\u0022\u003e\$(\u003c/span\u003elsb_release -cs\u003cspan style=\u0022color:#66d9ef\u0022\u003e)\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e stable\u0026#34;\u003c/span\u003e | sudo tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt update
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt install containerd -y
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow containerd should be installed, you can check with \u003ccode\u003ectr version\u003c/code\u003e to see if you can access it (some errors are fine, you just want to see a version number)\u003c/p\u003e
\u003ch3 id=\u0022cgroups\u0022\u003eCgroups\u003c/h3\u003e
\u003cp\u003eThe \u003ca href=\u0022https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cgroup-drivers\u0022\u003edocs\u003c/a\u003e tell you a lot about cgroups and cgroup drivers. Take a look there if you want to understand why it\u0026rsquo;s needed and what it\u0026rsquo;s doing. For the cluster setup, it\u0026rsquo;s just important to agree on one variant and enforce this in all components. I\u0026rsquo;m using the \u003ccode\u003esystemd\u003c/code\u003e driver and cgroup v2. To enforce this on Ubunut, we need to add a kernel parameter in the \u003ccode\u003eGRUB_CMDLINE_LINUX\u003c/code\u003e directive of \u003ccode\u003e/etc/default/grub\u003c/code\u003e:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eGRUB_CMDLINE_LINUX\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;systemd.unified_cgroup_hierarchy=1\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd run a \u003ccode\u003esudo update-grub\u003c/code\u003e followed by a reboot. Then we are sure, the system uses the correct cgroup driver and version.\u003c/p\u003e
\u003cp\u003eWe repeat the procedure and tell containerd to use systemd\u0026rsquo;s cgroup as well by modifiying \u003ccode\u003e/etc/containerd/config.toml\u003c/code\u003e:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecat \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;EOF | sudo tee -a /etc/containerd/config.toml
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e[plugins]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e  [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e   [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e      [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd.runtimes]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e        [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd.runtimes.runc]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e          runtime_type = \u0026#34;io.containerd.runc.v2\u0026#34;
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e          [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd.runtimes.runc.options]
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003e            SystemdCgroup = true
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eEOF\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo sed -i \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#39;s/^disabled_plugins \\=/\\#disabled_plugins \\=/g\u0026#39;\u003c/span\u003e /etc/containerd/config.toml
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNote: it\u0026rsquo;s possible that now all systems have the default configuration already in place for containerd. If you get an error saying the directory doesn\u0026rsquo;t exist, try the following and repeat the above commands:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo mkdir -p /etc/containerd
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd do a final restart of containerd:\u003c/p\u003e
\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003esudo systemctl restart containerd
sudo systemctl status containerd
\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\u0022kubeadm-kubectl-kubelet\u0022\u003ekubeadm, kubectl, kubelet\u003c/h3\u003e
\u003cp\u003eNext step is to get \u003ca href=\u0022https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl\u0022\u003ekubeadm\u003c/a\u003e (cluster bootstraping tool), kubectl and kubelet (cluster agent on systems) installed using package managers.\u003c/p\u003e
\u003cp\u003eBut to start we need to ensure some network settings are given. They should actually already be set when you used the above commands to install containerd.\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecat \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003ebr_netfilter
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eEOF\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecat \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003enet.bridge.bridge-nf-call-ip6tables = 1
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003enet.bridge.bridge-nf-call-iptables = 1
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#e6db74\u0022\u003eEOF\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo sysctl --system
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ethen we can add the necessary repository:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get update
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get install -y apt-transport-https ca-certificates curl
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eecho \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\u0026#34;\u003c/span\u003e | sudo tee /etc/apt/sources.list.d/kubernetes.list
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get update
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-get install -y kubelet kubeadm kubectl
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo apt-mark hold kubelet kubeadm kubectl
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNote: We mark kubelet, kubeadm and kubectl on hold so that they don\u0026rsquo;t get updated when updating other system packages. This is because they have to follow the versioning of Kubernetes and have some versions of room to differ. So it\u0026rsquo;s best to keep them at the same version as Kubernetes itself and update them when you update Kubernetes.\u003c/p\u003e
\u003cp\u003eMake sure you set the \u003ccode\u003ecgroupDriver: systemd\u003c/code\u003e when bootstraping the cluster so that the kubelet uses the same cgroup driver as the container runtime.\u003c/p\u003e
\u003ch3 id=\u0022cni-considerations\u0022\u003eCNI considerations\u003c/h3\u003e
\u003cp\u003eOne last thing before we can bootstrap our cluster is to choose a CNI for kubernetes. Although we could wait with that until kubeadm init is started we may need to set some flags in the init config to work with our CNI.\u003c/p\u003e
\u003cp\u003eAs said I\u0026rsquo;m using cilium. Cilium has two options for IPAM, one beeing kubernetes and one beeing cluster-scoped cilium mode. I\u0026rsquo;m using the later and also use the kube-proxy replacement of cilium which means I can completly ignore the flags for service and pod Subnets in kubeadm.\u003c/p\u003e
\u003ch2 id=\u0022bootstraping\u0022\u003eBootstraping\u003c/h2\u003e
\u003cp\u003eFinally we can \u003ca href=\u0022https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/\u0022\u003ebootstrap\u003c/a\u003e our cluster with kubeadm. For this we will create a kubeadm config to customize our installation:\u003c/p\u003e
\u003cp\u003eLet\u0026rsquo;s get the default config with:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ekubeadm config print init-defaults \u0026gt; kubeadm-config.yaml
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe are going to change some things in this default config. All options can be found in the \u003ca href=\u0022https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3\u0022\u003ereference docs\u003c/a\u003e. My file usually looks like that:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-yaml\u0022 data-lang=\u0022yaml\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e---
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eapiVersion\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003ekubeadm.k8s.io/v1beta3\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ekind\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003eClusterConfiguration\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eclusterName\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003etechnat.k8s\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003enetworking\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003ednsDomain: admin.alleaffengaffen.k8s # not necessary\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003ecustom internal dns domain\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003econtrolPlaneEndpoint\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003eadmin.alleaffengaffen.ch:6443\u003c/span\u003e \u003cspan style=\u0022color:#75715e\u0022\u003e# DNs record pointing to your master nodes\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e---
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eapiVersion\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003ekubelet.config.k8s.io/v1beta1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ekind\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003eKubeletConfiguration\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ecgroupDriver\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003esystemd\u003c/span\u003e \u003cspan style=\u0022color:#75715e\u0022\u003e# must match the value you set for containerd\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSome of the options are reasonable, some are only cosmetics and some are performance tweacks.
If you think the config looks good for you, you can start the initial bootstrap using the following command (remove the \u003ccode\u003e--skip-phase=addon/kube-proxy\u003c/code\u003e argument if you\u0026rsquo;re not using cilium):\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo kubeadm init --upload-certs --config kubeadm-config.yaml --skip-phases\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003eaddon/kube-proxy
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe output will clearly show when you had success initializing your control-plane and when not. Expect this to fail the first time. In my experience custom configs always lead to an error in the first place. But fortunately the commands shows you where to start debugging.\u003c/p\u003e
\u003cp\u003eIf it worked, you can then get the kubeconfig from the kubernetes directory to your regular user and start kubeing:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003emkdir -p \$HOME/.kube
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo chown \u003cspan style=\u0022color:#66d9ef\u0022\u003e\$(\u003c/span\u003eid -u\u003cspan style=\u0022color:#66d9ef\u0022\u003e)\u003c/span\u003e:\u003cspan style=\u0022color:#66d9ef\u0022\u003e\$(\u003c/span\u003eid -g\u003cspan style=\u0022color:#66d9ef\u0022\u003e)\u003c/span\u003e \$HOME/.kube/config
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor the root user, you can also just export the location of the kubeconfig:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003eexport KUBECONFIG\u003cspan style=\u0022color:#f92672\u0022\u003e=\u003c/span\u003e/etc/kubernetes/admin.conf
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\u0022deploy-cni\u0022\u003eDeploy CNI\u003c/h3\u003e
\u003cp\u003eBy now you might see that a \u003ccode\u003ekubectl get nodes\u003c/code\u003e lists the first master in a \u003ccode\u003eNot Ready\u003c/code\u003e state. This is due to the missing CNI.\u003c/p\u003e
\u003cp\u003eSo to install and verify the installation of cilium, before we continue to add nodes, we need \u003ccode\u003ehelm\u003c/code\u003e and the \u003ccode\u003ecilium\u003c/code\u003e cli:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecurl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz\u003cspan style=\u0022color:#f92672\u0022\u003e{\u003c/span\u003e,.sha256sum\u003cspan style=\u0022color:#f92672\u0022\u003e}\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esha256sum --check cilium-linux-amd64.tar.gz.sha256sum
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003esudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003erm cilium-linux-amd64.tar.gz\u003cspan style=\u0022color:#f92672\u0022\u003e{\u003c/span\u003e,.sha256sum\u003cspan style=\u0022color:#f92672\u0022\u003e}\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ecurl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003echmod \u003cspan style=\u0022color:#ae81ff\u0022\u003e700\u003c/span\u003e get_helm.sh
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e./get_helm.sh
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith those tools we can install cilium as a helm chart:\u003c/p\u003e
\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003ehelm repo add cilium https://helm.cilium.io/
helm upgrade -i cilium cilium/cilium -n kube-system -f cilium-values.yaml
\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSee that \u003ccode\u003e-f cilium-values.yaml\u003c/code\u003e at the end of the last command? That\u0026rsquo;s the config for cilium. It looks like that for me:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-yaml\u0022 data-lang=\u0022yaml\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003erollOutCiliumPods\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003epriorityClassName\u003c/span\u003e: \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;system-node-critical\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eannotateK8sNode\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003econtainerRuntime\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003eintegration\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003econtainerd\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003esocketPath\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003e/var/run/containerd/containerd.sock\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eencryption\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003eenabled\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003etype\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003ewireguard\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003eoperator\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003ereplicas\u003c/span\u003e: \u003cspan style=\u0022color:#ae81ff\u0022\u003e1\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003el7Proxy\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003efalse\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ehubble\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003eenabled\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003erelay\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e    \u003cspan style=\u0022color:#f92672\u0022\u003eenabled\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e  \u003cspan style=\u0022color:#f92672\u0022\u003eui\u003c/span\u003e:
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e    \u003cspan style=\u0022color:#f92672\u0022\u003eenabled\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e    \u003cspan style=\u0022color:#f92672\u0022\u003erollOutPods\u003c/span\u003e: \u003cspan style=\u0022color:#66d9ef\u0022\u003etrue\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003epolicyEnforcementMode\u003c/span\u003e: \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;none\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ekubeProxyReplacement\u003c/span\u003e: \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;strict\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ek8sServiceHost\u003c/span\u003e: \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;admin.alleaffengaffen.ch\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#f92672\u0022\u003ek8sServicePort\u003c/span\u003e: \u003cspan style=\u0022color:#e6db74\u0022\u003e\u0026#34;6443\u0026#34;\u003c/span\u003e
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can get the default config using \u003ccode\u003ehelm show values cilium/cilium\u003c/code\u003e and then customize this to your needs.\u003c/p\u003e
\u003ch3 id=\u0022join-master-nodes\u0022\u003eJoin master nodes\u003c/h3\u003e
\u003cp\u003eTo join the other master nodes to the cluster, copy the command from our init output and run it on the other master nodes:\u003c/p\u003e
\u003cdiv class=\u0022highlight\u0022\u003e\u003cpre tabindex=\u00220\u0022 style=\u0022color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\u0022\u003e\u003ccode class=\u0022language-bash\u0022 data-lang=\u0022bash\u0022\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003ekubeadm join admin.alleaffengaffen.ch:6443 --token blfexx.ei3cp7hozu27ebpg \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e       --discovery-token-ca-cert-hash sha256:fd3c9d6595ed7de9cd3f5c66435cbfcbbfddcc782e37c16a4824fff04c23430d \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e       --control-plane --certificate-key b5c99a41b7f16ef635619c6e972d29ec4ac921dff85839815b51652ab39447b7 \u003cspan style=\u0022color:#ae81ff\u0022\u003e\\
\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\u0022display:flex;\u0022\u003e\u003cspan\u003e\u003cspan style=\u0022color:#ae81ff\u0022\u003e\u003c/span\u003e       -f kubeadm-config.yaml
\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\u0022join-workers\u0022\u003eJoin Workers\u003c/h3\u003e
\u003cp\u003eNow any number of worker nodes can be joined using the command:\u003c/p\u003e
\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003esudo kubeadm join admin.alleaffengaffen.ch:6443 --token dt4vt3.c833o3z5fcdmbj37 \\
	--discovery-token-ca-cert-hash sha256:dd3d4f4a3bee384d4ebe539d24d38bb11bcfb765a066b03fb8b79676a33cc902
\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\u0022post-setup\u0022\u003ePost-Setup\u003c/h2\u003e
\u003cp\u003eBootstraped and now? There are a few things we should think about now.\u003c/p\u003e
\u003ch3 id=\u0022kubectl-completion\u0022\u003ekubectl completion\u003c/h3\u003e
\u003cp\u003eVery very helpful: \u003ca href=\u0022https://kubernetes.io/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/\u0022\u003ekubectl completion\u003c/a\u003e\u003c/p\u003e
\u003ch3 id=\u0022etcdctl\u0022\u003eetcdctl\u003c/h3\u003e
\u003cp\u003eThe package \u003ccode\u003eetcd-client\u003c/code\u003e provides us with a \u003ccode\u003eetcdctl\u003c/code\u003e that can be used to interact with the etcd cluster that backes the control-plane. However the tool needs some flags to be passed into for usage. I recommend you save yourself the following as an alias:\u003c/p\u003e
\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003eETCDCTL_API=3 sudo etcdctl --endpoints https://192.168.112.51:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key
\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\u0022taints\u0022\u003eTaints\u003c/h3\u003e
\u003cp\u003eMake sure the master nodes have their taint on them so that only control-plane components are scheduled on them:\u003c/p\u003e
\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003ek taint nodes lion node-role.kubernetes.io/master:NoSchedule
\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\u0022type-loadbalancer\u0022\u003etype: LoadBalancer\u003c/h3\u003e
\u003cp\u003eYou may have noticied that I installed my K8s cluster on Hetzner. But as you might now, the cloud controller manager of K8s does not support interacting with Hetzner to provision LoadBalancers for Services.\u003c/p\u003e
\u003cp\u003eThis is the point where the \u003ca href=\u0022https://github.com/hetznercloud/hcloud-cloud-controller-manager\u0022\u003ehcloud-cloud-controller-manager\u003c/a\u003e comes into play. This is a simple controller that talks to the Hetzner API and enriches your nods with some labels about the typology and provisions LBs if desired.\u003c/p\u003e
\u003cp\u003eSee the repo for a quickstart how to install the manager.\u003c/p\u003e
\u003c/span\u003e`,"activity-content",contentDelay)};typeeffetct()</script></div><span class=navFull><span><a href=/>Home</a>
<span>&#8192;|&#8192;</span>
<a href=./..>/kubernetes/</a></span>
<span class=navCredits>Hugo theme created by
<a href=https://github.com/Yukuro/hugo-theme-shell target=_blank rel=noopener>Yukuro</a></span></span></body></html>